name: Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            version: ${{ steps.get_version.outputs.version }}

        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: PassKeyPer ${{ github.ref }}
                  draft: false
                  prerelease: false
                  body: |
                      ## âœ¨ What's New

                      See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

                      ## ðŸ“¦ Downloads

                      ### Desktop
                      - **Windows**: PassKeyPer-Setup-Windows-x64.exe
                      - **macOS**: PassKeyPer-macOS-x64.dmg
                      - **Linux**: PassKeyPer-Linux-x86_64.AppImage

                      ### Mobile
                      - **Android**: PassKeyPer-Android.apk

                      ### Browser Extensions
                      - **Chrome/Edge**: PassKeyPer-Chrome.zip (load unpacked or submit to Chrome Web Store)
                      - **Firefox**: PassKeyPer-Firefox.zip (load as temporary add-on or submit to AMO)

    build-desktop:
        name: Build Desktop (${{ matrix.os }})
        needs: create-release
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                include:
                    - os: windows-latest
                      artifact_name: "*.exe"
                      asset_name: PassKeyPer-Setup-Windows-x64.exe
                    - os: macos-latest
                      artifact_name: "*.dmg"
                      asset_name: PassKeyPer-macOS-x64.dmg
                    - os: ubuntu-latest
                      artifact_name: "*.AppImage"
                      asset_name: PassKeyPer-Linux-x86_64.AppImage

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build desktop app
              run: |
                  cd apps/desktop
                  npm run electron:build
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Find artifact
              id: find_artifact
              shell: bash
              run: |
                  ARTIFACT=$(find apps/desktop/release -name "${{ matrix.artifact_name }}" -type f | head -1)
                  echo "artifact_path=$ARTIFACT" >> $GITHUB_OUTPUT

            - name: Upload Release Asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ${{ steps.find_artifact.outputs.artifact_path }}
                  asset_name: ${{ matrix.asset_name }}
                  asset_content_type: application/octet-stream

    build-android:
        name: Build Android APK
        needs: create-release
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Install mobile dependencies
              run: |
                  cd apps/mobile
                  npm ci

            - name: Generate Android project
              run: |
                  cd apps/mobile
                  npx expo prebuild --platform android

            - name: Make gradlew executable
              run: chmod +x apps/mobile/android/gradlew

            - name: Build Android APK
              run: |
                  cd apps/mobile/android
                  ./gradlew assembleRelease

            - name: Sign APK (debug key for now)
              run: |
                  cd apps/mobile/android
                  ./gradlew assembleDebug

            - name: Find APK
              id: find_apk
              run: |
                  APK=$(find apps/mobile/android/app/build/outputs/apk -name "*.apk" -type f | head -1)
                  echo "apk_path=$APK" >> $GITHUB_OUTPUT

            - name: Upload Android APK
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ${{ steps.find_apk.outputs.apk_path }}
                  asset_name: PassKeyPer-Android.apk
                  asset_content_type: application/vnd.android.package-archive

    build-extension:
        name: Build Browser Extension
        needs: create-release
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build extension
              run: |
                  cd apps/extension
                  npm run build

            - name: Package Chrome Extension
              run: |
                  cd apps/extension/dist
                  zip -r ../PassKeyPer-Chrome.zip .

            - name: Upload Chrome Extension
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: apps/extension/PassKeyPer-Chrome.zip
                  asset_name: PassKeyPer-Chrome.zip
                  asset_content_type: application/zip

            - name: Create Firefox manifest
              run: |
                  cd apps/extension/dist
                  # Convert manifest v3 to v2 for Firefox compatibility
                  node -e "
                  const fs = require('fs');
                  const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
                  manifest.manifest_version = 2;
                  manifest.browser_specific_settings = {
                    gecko: {
                      id: 'passkeyper@passkeyper.com',
                      strict_min_version: '109.0'
                    }
                  };
                  if (manifest.background?.service_worker) {
                    manifest.background = { scripts: ['background.js'] };
                  }
                  if (manifest.action) {
                    manifest.browser_action = manifest.action;
                    delete manifest.action;
                  }
                  fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
                  "

            - name: Package Firefox Extension
              run: |
                  cd apps/extension/dist
                  zip -r ../PassKeyPer-Firefox.zip .

            - name: Upload Firefox Extension
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: apps/extension/PassKeyPer-Firefox.zip
                  asset_name: PassKeyPer-Firefox.zip
                  asset_content_type: application/zip
