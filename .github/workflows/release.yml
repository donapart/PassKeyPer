name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build-desktop-windows:
        name: Build Desktop (Windows)
        runs-on: windows-latest
        
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build desktop app
              run: |
                  cd apps/desktop
                  npm run electron:build
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Find and rename artifact
              id: find_artifact
              shell: pwsh
              run: |
                  $ARTIFACT = Get-ChildItem -Path "apps/desktop/release" -Filter "*.exe" -Recurse | Select-Object -First 1
                  Copy-Item $ARTIFACT.FullName -Destination "PassKeyPer-Setup-Windows-x64.exe"
                  echo "artifact_path=PassKeyPer-Setup-Windows-x64.exe" >> $env:GITHUB_OUTPUT

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PassKeyPer-Setup-Windows-x64.exe
                  path: PassKeyPer-Setup-Windows-x64.exe

    build-desktop-linux:
        name: Build Desktop (Linux)
        runs-on: ubuntu-latest
        
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build desktop app
              run: |
                  cd apps/desktop
                  npm run electron:build
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Find and rename artifact
              id: find_artifact
              run: |
                  ARTIFACT=$(find apps/desktop/release -name "*.AppImage" -type f | head -1)
                  if [ -n "$ARTIFACT" ]; then
                    cp "$ARTIFACT" PassKeyPer-Linux-x86_64.AppImage
                    echo "artifact_path=PassKeyPer-Linux-x86_64.AppImage" >> $GITHUB_OUTPUT
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              if: success()
              with:
                  name: PassKeyPer-Linux-x86_64.AppImage
                  path: PassKeyPer-Linux-x86_64.AppImage
                  if-no-files-found: warn

    build-extension:
        name: Build Browser Extension
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build extension
              run: |
                  cd apps/extension
                  npm run build

            - name: Package Chrome Extension
              run: |
                  cd apps/extension/dist
                  zip -r ../PassKeyPer-Chrome.zip .

            - name: Upload Chrome artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PassKeyPer-Chrome.zip
                  path: apps/extension/PassKeyPer-Chrome.zip

    release:
        name: Create Release
        needs: [build-desktop-windows, build-desktop-linux, build-extension]
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: release-assets
                  merge-multiple: true

            - name: List downloaded artifacts
              run: ls -la release-assets/ || echo "No artifacts found"

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: PassKeyPer ${{ github.ref_name }}
                  draft: false
                  prerelease: false
                  files: release-assets/*
                  fail_on_unmatched_files: false
                  body: |
                      ## ‚ú® PassKeyPer ${{ github.ref_name }}

                      See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

                      ## üì¶ Downloads

                      ### Desktop
                      | Platform | Download |
                      |----------|----------|
                      | Windows | [PassKeyPer-Setup-Windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Setup-Windows-x64.exe) |
                      | Linux | [PassKeyPer-Linux-x86_64.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Linux-x86_64.AppImage) |

                      ### Browser Extensions
                      | Browser | Download |
                      |---------|----------|
                      | Chrome / Edge | [PassKeyPer-Chrome.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Chrome.zip) |

                      ---
                      
                      **Installation:**
                      - **Desktop**: Run the installer or extract and run
                      - **Chrome/Edge**: Unzip, go to `chrome://extensions`, enable Developer mode, "Load unpacked"
                      
                      ---
                      
                      ‚ö†Ô∏è **Note**: macOS and Android builds require manual build. See the [build instructions](https://github.com/${{ github.repository }}#building-from-source) for details.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
