name: Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}

        steps:
            - uses: actions/checkout@v4

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: PassKeyPer ${{ github.ref }}
                  draft: false
                  prerelease: false
                  body: |
                      ## âœ¨ What's New

                      See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

                      ## ðŸ“¦ Downloads

                      - **Windows**: PassKeyPer-Setup-x64.exe
                      - **macOS**: PassKeyPer-x64.dmg
                      - **Linux**: PassKeyPer-x86_64.AppImage

    build-and-upload:
        name: Build and Upload
        needs: create-release
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                include:
                    - os: windows-latest
                      artifact_name: PassKeyPer-Setup-*.exe
                      asset_name: PassKeyPer-Setup-Windows-x64.exe
                    - os: macos-latest
                      artifact_name: PassKeyPer-*.dmg
                      asset_name: PassKeyPer-macOS-x64.dmg
                    - os: ubuntu-latest
                      artifact_name: PassKeyPer-*.AppImage
                      asset_name: PassKeyPer-Linux-x86_64.AppImage

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build desktop app
              run: |
                  cd apps/desktop
                  npm run electron:build
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload Release Asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: apps/desktop/release/${{ matrix.artifact_name }}
                  asset_name: ${{ matrix.asset_name }}
                  asset_content_type: application/octet-stream
