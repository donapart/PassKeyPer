name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build-desktop:
        name: Build Desktop (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: windows-latest
                      artifact_name: "*.exe"
                      asset_name: PassKeyPer-Setup-Windows-x64.exe
                    - os: macos-latest
                      artifact_name: "*.dmg"
                      asset_name: PassKeyPer-macOS-x64.dmg
                    - os: ubuntu-latest
                      artifact_name: "*.AppImage"
                      asset_name: PassKeyPer-Linux-x86_64.AppImage

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build desktop app
              run: |
                  cd apps/desktop
                  npm run electron:build
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Find and rename artifact
              id: find_artifact
              shell: bash
              run: |
                  ARTIFACT=$(find apps/desktop/release -name "${{ matrix.artifact_name }}" -type f | head -1)
                  cp "$ARTIFACT" "${{ matrix.asset_name }}"
                  echo "artifact_path=${{ matrix.asset_name }}" >> $GITHUB_OUTPUT

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.asset_name }}
                  path: ${{ steps.find_artifact.outputs.artifact_path }}

    build-android:
        name: Build Android APK
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Install mobile dependencies
              run: |
                  cd apps/mobile
                  npm ci

            - name: Generate Android project
              run: |
                  cd apps/mobile
                  npx expo prebuild --platform android

            - name: Make gradlew executable
              run: chmod +x apps/mobile/android/gradlew

            - name: Build Android APK
              run: |
                  cd apps/mobile/android
                  ./gradlew assembleDebug

            - name: Find and rename APK
              id: find_apk
              run: |
                  APK=$(find apps/mobile/android/app/build/outputs/apk -name "*.apk" -type f | head -1)
                  cp "$APK" PassKeyPer-Android.apk
                  echo "apk_path=PassKeyPer-Android.apk" >> $GITHUB_OUTPUT

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PassKeyPer-Android.apk
                  path: PassKeyPer-Android.apk

    build-extension:
        name: Build Browser Extension
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build packages
              run: npm run build

            - name: Build extension
              run: |
                  cd apps/extension
                  npm run build

            - name: Package Chrome Extension
              run: |
                  cd apps/extension/dist
                  zip -r ../PassKeyPer-Chrome.zip .

            - name: Upload Chrome artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PassKeyPer-Chrome.zip
                  path: apps/extension/PassKeyPer-Chrome.zip

            - name: Create Firefox manifest
              run: |
                  cd apps/extension/dist
                  node -e "
                  const fs = require('fs');
                  const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
                  manifest.manifest_version = 2;
                  manifest.browser_specific_settings = {
                    gecko: {
                      id: 'passkeyper@passkeyper.com',
                      strict_min_version: '109.0'
                    }
                  };
                  if (manifest.background && manifest.background.service_worker) {
                    manifest.background = { scripts: ['background.js'] };
                  }
                  if (manifest.action) {
                    manifest.browser_action = manifest.action;
                    delete manifest.action;
                  }
                  fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
                  "

            - name: Package Firefox Extension
              run: |
                  cd apps/extension/dist
                  zip -r ../PassKeyPer-Firefox.zip .

            - name: Upload Firefox artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PassKeyPer-Firefox.zip
                  path: apps/extension/PassKeyPer-Firefox.zip

    release:
        name: Create Release
        needs: [build-desktop, build-android, build-extension]
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: release-assets
                  merge-multiple: true

            - name: List downloaded artifacts
              run: ls -la release-assets/

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: PassKeyPer ${{ github.ref_name }}
                  draft: false
                  prerelease: false
                  files: release-assets/*
                  body: |
                      ## âœ¨ PassKeyPer ${{ github.ref_name }}

                      See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

                      ## ðŸ“¦ Downloads

                      ### Desktop
                      | Platform | Download |
                      |----------|----------|
                      | Windows | [PassKeyPer-Setup-Windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Setup-Windows-x64.exe) |
                      | macOS | [PassKeyPer-macOS-x64.dmg](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-macOS-x64.dmg) |
                      | Linux | [PassKeyPer-Linux-x86_64.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Linux-x86_64.AppImage) |

                      ### Mobile
                      | Platform | Download |
                      |----------|----------|
                      | Android | [PassKeyPer-Android.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Android.apk) |

                      ### Browser Extensions
                      | Browser | Download |
                      |---------|----------|
                      | Chrome / Edge | [PassKeyPer-Chrome.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Chrome.zip) |
                      | Firefox | [PassKeyPer-Firefox.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/PassKeyPer-Firefox.zip) |

                      ---
                      
                      **Installation:**
                      - **Desktop**: Run the installer or extract and run
                      - **Android**: Enable "Install from unknown sources" and install the APK
                      - **Chrome/Edge**: Unzip, go to `chrome://extensions`, enable Developer mode, "Load unpacked"
                      - **Firefox**: Unzip, go to `about:debugging`, "Load Temporary Add-on"
